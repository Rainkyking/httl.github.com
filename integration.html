<!doctype html>
<!--[if lt IE 7]><html class="no-js ie6 oldie" lang="en"><![endif]-->
<!--[if IE 7]><html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]><html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><html class="no-js ieg8" lang="en"> <![endif]-->
<html>
<head>
<meta charset="utf-8">
<title>HTTL - 开源Java模板引擎</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="apple-touch-icon" href="img/apple-touch-icon.png"/>
<link rel="shortcut icon" href="favicon.ico" />
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Lato:400,700" />
<link rel="stylesheet" type="text/css" href="css/style.css" />
<link rel="stylesheet" type="text/css" href="css/style-mobile.css" media="only screen and (max-width: 480px)" />
<link rel="stylesheet" type="text/css" href="css/httl.css" />
<link rel="stylesheet" type="text/css" href="css/httl-mobile.css" media="only screen and (max-width: 480px)" />
<link rel="stylesheet" type="text/css" href="css/shCoreDefault.css" />
<script type="text/javascript" src="js/modernizr-2.0.6.min.js"></script>
<script type="text/javascript" src="js/jquery-1.6.2.min.js"></script>
<script type="text/javascript" src="js/httl.js"></script>
<script type="text/javascript" src="js/shCore.js"></script>
<script type="text/javascript" src="js/shBrushXml.js"></script>
<script type="text/javascript" src="js/shBrushJava.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();</script>
</head>
<body class="home ">
    <a href="http://github.com/httl/httl"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub" class="fork-me-on-github"></a>
    <div class="container">
        <header>
            <div class="logo">
	           <a href="/">HTTL</a>
            </div>
            <div id="headline" class="headline">
                <h1>模板引擎</h1>
                <ul>
                  <li>简洁友好的模板语法</li>
                  <li>精益求精的性能优化</li>
                  <li>高质量的设计与实现</li>
                </ul>
            </div>
        </header>
        <nav class="primary-nav">
            <a href="/"><img src="img/icon-overview.png"> 概述</a>
            <a href="download.html"><img src="img/icon-download.png"> 下载</a>
            <a href="example.html"><img src="img/icon-example.png"> 示例</a>
            <a href="syntax.html"><img src="img/icon-syntax.png"> 语法</a>
            <a href="config.html"><img src="img/icon-config.png"> 配置</a>
            <a href="integration.html"><img src="img/icon-integration.png"> 集成</a>
            <a href="design.html"><img src="img/icon-design.png"> 设计</a>
            <a href="help.html"><img src="img/icon-help.png"> 帮助</a>
        </nav>
    <div class="content">
      <div class="body-content ">
        <section>

<h1>集成</h1>

<p>HTTL已内置集成常用MVC框架，你也可以自行使用HTTL的API进行集成。</p>

<h2>API集成</h1>

<h3>API一览表</h3>

<p>Engine: (加载后不可变，线程安全，请复用单例)</p>

<ul>
<li>Engine.getEngine() 获取引擎单例</li>
<li>Engine.getTemplate(name) 基于模板名查询模板实例</li>
<li>Engine.parseTemplate(src) 解析模板源码为模板实例</li>
<li>Engine.getResource(name) 获取资源文件</li>
<li>Engine.hasResource(name) 判断资源文件是否存在</li>
<li>Engine.getProperty(key) 获取配置项属性值</li>
<li>Engine.getName() 获取配置文件名</li>
<li>Engine.getVersion() 获取HTTL版本</li>
</ul>

<p>Template: (继承于Node和Resource，每模板原型实例，加载后不可变类，线程安全，热加载将产生不同实例)</p>

<ul>
<li>Template.render(map,writer) 基于参数渲染模板内容到输出中</li>
<li>Template.evaluate(map) 基于参数求值模板内容</li>
<li>Template.getVariables() 获取需要的参数类型</li>
<li>Template.getMacros() 获取模板中的宏</li>
<li>Template.isMacro() 当前模板是否为宏</li>
<li>Node.accept(Visitor) 访问语法树</li>
<li>Node.getOffset() 获取片断源位置偏移量</li>
<li>Node.getParent() 获取父节点</li>
<li>Resource.getInputStream() 获取模板源输入流</li>
<li>Resource.getReader() 获取模板源读取器</li>
<li>Resource.getSource() 获取模板源代码</li>
<li>Resource.getName() 获取模板源名称</li>
<li>Resource.getEncoding() 获取模板源编码</li>
<li>Resource.getLastModified() 获取模板源最后修改时间</li>
<li>Resource.getLocale() 获取模板本地化区域</li>
<li>Resource.getLength() 获取模板源长度</li>
</ul>

<p>Context: (线程绑定实例，线程栈内无竞争使用，线程安全，请不要跨线程传递)</p>

<ul>
<li>Context.getContext() 获取当前线程上下文</li>
<li>Context.getParent() 获取上一级上下文</li>
<li>Context.getSuper() 获取上一级模板</li>
<li>Context.getTemplate() 获取当前执行的模板</li>
<li>Context.getEngine() 获取当前执行的引擎</li>
<li>Context.getOut() 获取当前输出</li>
<li>Context.getLevel() 获取当前上下文层级</li>
<li>Context.get(String) 获取上下文变量</li>
<li>Context.put(String,Object) 写法上下文变量</li>
</ul>

<h3>API集成示例</h3>

<pre class="brush: java;">
import httl.*;
import java.util.*;

Map&lt;String, Object&gt; parameters = new HashMap&lt;String, Object&gt;();
parameters.put("user", user);
parameters.put("books", books);

Engine engine = Engine.getEngine();
Template template = engine.getTemplate("/books.httl");
template.render(parameters, response.getOutputStream());
</pre>

<p>注：缺省配置下，HTTL不依赖任何三方库，只需JDK1.5+即可。</p>

<p>注：缺省必须要用JDK运行，如果只有JRE，请配置为JavassistCompiler。</p>

<p>下面的调用只是演示集成中你能获取到的信息：</p>

<pre class="brush: java;">
// 你可以传入Template对象，在模板中直接调用：$!{template}
// 注意：HTTL在发现Template对象时，会直接把output往下传，而不是拷贝结果。
parameters.put("template", template);

// 你也可以执行模板拿到渲染结果：
String result = (String) template.evaluate(parameters); 
// 注意：如果你只是为了把A模板的结果传给B模板，请不要用这种先求值，再传变量的方式。
// 因为这会浪费一次内存拷贝，请直接将template传入，可以减少result中间变量的内存占用。
parameters.put("template", result);  // 错误用法，应直接传入template对象

// 你可以拿到模板中的set赋值：
// 注意：如果要在模板渲染完之后拿到变量，要用#set(title := "foo")写到上级Context中。
// 因为模板渲染完时会弹出Context栈，模板Context中的变量都会消失，只有写到上级Context中变量保留。
String title = (String) Context.getContext().get("title");

// 你也可以拿到模板中的宏：（你可以把宏理解为片断模板）
Template macro = template.getMacros().get("menus");

// 如果你要写测试工具，你可以获取到模板所需的变量和类型，去Mock数据。
Map&lt;String, Class&lt;?&gt;&gt; parameterTypes = template.getVariableTypes();

// 同理，你也可以获取到模板向上级Context中输出的变量和类型。
Map&lt;String, Class&lt;?&gt;&gt; contextTypes = template.getExportTypes();
</pre>

<h3>ScriptEngine集成</h3>

<p>你也可以使用JDK标准的脚本API，这样可以不显式依赖HTTL的任何类：</p>

<pre class="brush: java;">
import javax.script.*

ScriptEngineManager manager = new ScriptEngineManager();
ScriptEngine engine = manager.getEngineByName("httl");

Bindings bindings = engine.createBindings();
bindings.put("hello", "world");

CompiledScript script = engine.compile("${hello}");
String result = (String) script.eval(bindings);
</pre>

<h2>MVC集成</h2>

<p>HTTL在MVC中的定位：</p>

<p><img src="images/httl-mvc.png" alt="MVC"></p>

<h3>配置查找顺序</h3>

<p>(1) 首先查找/WEB-INF/web.xml中的context-param指定的配置：</p>

<pre class="brush: xml;">
&lt;context-param&gt;
    &lt;param-name&gt;httl.properties&lt;/param-name&gt;
    &lt;param-value&gt;/WEB-INF/httl.properties&lt;/param-value&gt;
&lt;/context-param&gt;
</pre>

<p>(注：如果配置路径以 / 开头则表示在Web应用目录下，否则在ClassPath下查找)</p>

<p>(2) 如果未配置，则查找默认WEB-INF路径：/WEB-INF/httl.properties</p>

<p>(3) 如果WEB-INF中没有，则查找ClassPath根目录：httl.properties</p>

<p>(4) 如果ClassPath根目录也没有，则使用标准配置。</p>

<h3>变量查找顺序</h3>

<p>以${foo}为例：</p>

<p>(1) 首先查找当前模板内#set赋值的变量。</p>

<p>(2) 再查找业务Controller返回的变量。</p>

<p>(3) 然后查找请求属性：request.getAttribute("foo")</p>

<p>(4) 然后查找请求参数：request.getParameter("foo")</p>

<p>(5) 然后查找请求头：request.getHeader("foo")</p>

<p>(6) 然后查找临时会话属性：session.getAttribute("foo")</p>

<p>(7) 然后查找持外会话属性：cookie.get("foo")</p>

<p>(8) 然后查找应用属性：servletContext.getAttribute("foo")</p>

<p>也可以指定访问的域：</p>

<p>(1) ${request.foo} 返回请求属性：request.getAttribute("foo")</p>

<p>(2) ${parameter.foo} 返回请求参数：request.getParameter("foo")</p>

<p>(3) ${header.foo} 返回请求头：request.getHeader("foo")</p>

<p>(4) ${session.foo} 返回临时会话属性：session.getAttribute("foo")</p>

<p>(5) ${cookie.foo} 返回持久会话属性：cookie.get("foo")</p>

<p>(6) ${application.foo} 返回应用属性：servletContext.getAttribute("foo")</p>

<h3>SpringMVC集成</h3>

<p>配置/WEB-INF/web.xml:</p>

<pre class="brush: xml;">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xmlns="http://java.sun.com/xml/ns/javaee" xmlns:web="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
		xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
		version="2.5"&gt;

	&lt;listener&gt;
		&lt;listener-class&gt;org.springframework.web.context.ContextLoaderListener&lt;/listener-class&gt;
	&lt;/listener&gt;

	&lt;servlet&gt;
		&lt;servlet-name&gt;springmvc&lt;/servlet-name&gt;
		&lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
		&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
	&lt;/servlet&gt;

	&lt;servlet-mapping&gt;
		&lt;servlet-name&gt;springmvc&lt;/servlet-name&gt;
		&lt;url-pattern&gt;/*&lt;/url-pattern&gt;
	&lt;/servlet-mapping&gt;

&lt;/web-app&gt;
</pre>

<p>配置/WEB-INF/springmvc-servlet.xml:</p>

<pre class="brush: xml;">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN 2.0//EN" 
    "http://www.springframework.org/dtd/spring-beans-2.0.dtd"&gt;
&lt;beans&gt;
    &lt;bean id="viewResolver" class="httl.web.springmvc.HttlViewResolver"&gt;
        &lt;property name="contentType" value="text/html; charset=UTF-8" /&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</pre>

<p>示例源码仓库：<a href="https://github.com/httl/httl-springmvc">https://github.com/httl/httl-springmvc</a></p>

<p>示例包下载参见：<a href="download.html">下载</a></p>

<h3>Struts集成</h3>

<p>配置/WEB-INF/web.xml:</p>

<pre class="brush: xml;">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xmlns="http://java.sun.com/xml/ns/javaee" xmlns:web="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
		xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
		version="2.5"&gt;

	&lt;filter&gt;
		&lt;filter-name&gt;struts&lt;/filter-name&gt;
		&lt;filter-class&gt;org.apache.struts2.dispatcher.FilterDispatcher&lt;/filter-class&gt;
	&lt;/filter&gt;
	
	&lt;filter-mapping&gt;
		&lt;filter-name&gt;struts&lt;/filter-name&gt;
		&lt;url-pattern&gt;/*&lt;/url-pattern&gt;
	&lt;/filter-mapping&gt;

&lt;/web-app&gt;
</pre>

<p>配置classpath:struts.xml:</p>

<pre class="brush: xml;">
&lt;?xml version="1.0" encoding="UTF-8"?&gt;  
&lt;!DOCTYPE struts PUBLIC  
    "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"  
    "http://struts.apache.org/dtds/struts-2.0.dtd"&gt;
&lt;struts&gt;
    &lt;package name="hello" extends="httl-default"&gt;
        &lt;action name="helloWorld" class="com.hello.HelloWorld"&gt;
            &lt;result type="httl"&gt;/hello_world.httl&lt;/result&gt;
		&lt;/action&gt;
    &lt;/package&gt;
&lt;/struts&gt;
</pre>

<p>配置/WEB-INF/httl.properties：</p>

<pre class="brush: java;">import.packages+=com.your.domain
template.directory=/WEB-INF/templates
message.basename=/WEB-INF/messages
input.encoding=UTF-8
output.encoding=UTF-8
reloadable=false
precompiled=false
localized=false
</pre>

<p>示例源码仓库：<a href="https://github.com/httl/httl-struts">https://github.com/httl/httl-struts</a></p>

<p>示例包下载参见：<a href="download.html">下载</a></p>

<h3>Webx集成</h3>

<p>配置/WEB-INF/web.xml:</p>

<pre class="brush: xml;">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xmlns="http://java.sun.com/xml/ns/javaee" xmlns:web="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
		xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
		version="2.5"&gt;

	&lt;filter&gt;
		&lt;filter-name&gt;webx&lt;/filter-name&gt;
		&lt;filter-class&gt;com.alibaba.citrus.webx.servlet.WebxFrameworkFilter&lt;/filter-class&gt;
		&lt;init-param&gt;
			&lt;param-name&gt;excludes&lt;/param-name&gt;
			&lt;param-value&gt;*.css, *.js, *.jpg, *.gif, *.png&lt;/param-value&gt;
		&lt;/init-param&gt;
	&lt;/filter&gt;

	&lt;filter-mapping&gt;
		&lt;filter-name&gt;webx&lt;/filter-name&gt;
		&lt;url-pattern&gt;/*&lt;/url-pattern&gt;
	&lt;/filter-mapping&gt;

&lt;/web-app&gt;
</pre>

<p>配置/WEB-INF/webx.xml:</p>

<pre class="brush: xml;">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
 Webx Root Context Configuration.  
&lt;beans:beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:beans="http://www.springframework.org/schema/beans"
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:services="http://www.alibaba.com/schema/services"
    xmlns:engines="http://www.alibaba.com/schema/services/template/engines"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
    		http://www.alibaba.com/schema/services http://localhost:8080/schema/services.xsd
        	http://www.alibaba.com/schema/services/template/engines http://localhost:8080/schema/services/template/engines.xsd"&gt;

	&lt;services:template&gt;
        &lt;engines:httl-engine /&gt;
	&lt;/services:template&gt;

&lt;/beans:beans&gt;
</pre>

<p>配置/WEB-INF/httl.properties：</p>

<pre class="brush: java;">import.packages+=com.your.domain
template.directory=/WEB-INF/templates
message.basename=/WEB-INF/messages
input.encoding=UTF-8
output.encoding=UTF-8
reloadable=false
precompiled=false
localized=false
</pre>

<p>示例源码仓库：<a href="https://github.com/httl/httl-webx">https://github.com/httl/httl-webx</a></p>

<p>示例包下载参见：<a href="download.html">下载</a></p>

<h3>Servlet集成</h3>

<p>你需要在你的业务Servlet中，处理完业务后，将业务参数都写到request.setAttribute()中。</p>

<p>HttlFilter会在业务Servlet执行后，从模板目录下读取与请求path同名，后缀换成.httl的模板，然后以request中的变量进行渲染。</p>

<p>如需执行非同名模板，可将请求forward到指定模板，HttlServlet会在模板目录下读取forward过来的path同名的模板，然后以request中的变量进行渲染。
比如：request.getRequestDispatcher("foo.httl").forward(request, response);</p>

<p>配置/WEB-INF/web.xml:</p>

<pre class="brush: xml;">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		xmlns="http://java.sun.com/xml/ns/javaee" xmlns:web="http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
		xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"
		version="2.5"&gt;

	&lt;servlet&gt;
	    &lt;servlet-name&gt;yourServlet&lt;/servlet-name&gt;
	    &lt;servlet-class&gt;com.foo.YourServlet&lt;/servlet-class&gt;
	    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
	&lt;/servlet&gt;

	&lt;servlet-mapping&gt;
	    &lt;servlet-name&gt;yourServlet&lt;/servlet-name&gt;
	    &lt;url-pattern&gt;*.do&lt;/url-pattern&gt;
	&lt;/servlet-mapping&gt;

	&lt;servlet&gt;
	    &lt;servlet-name&gt;httlServlet&lt;/servlet-name&gt;
	    &lt;servlet-class&gt;httl.web.servlet.HttlServlet&lt;/servlet-class&gt;
	    &lt;load-on-startup&gt;2&lt;/load-on-startup&gt;
	&lt;/servlet&gt;

	&lt;servlet-mapping&gt;
	    &lt;servlet-name&gt;httlServlet&lt;/servlet-name&gt;
	    &lt;url-pattern&gt;*.httl&lt;/url-pattern&gt;
	&lt;/servlet-mapping&gt;

	&lt;filter&gt;
	    &lt;filter-name&gt;httlFilter&lt;/filter-name&gt;
	    &lt;filter-class&gt;httl.web.servlet.HttlFilter&lt;/filter-class&gt;
	&lt;/filter&gt;

	&lt;filter-mapping&gt;
	    &lt;filter-name&gt;httlFilter&lt;/filter-name&gt;
	    &lt;url-pattern&gt;*.do&lt;/url-pattern&gt;
	&lt;/filter-mapping&gt;

&lt;/web-app&gt;
</pre>

<p>配置/WEB-INF/httl.properties：</p>

<pre class="brush: java;">import.packages+=com.your.domain
template.directory=/WEB-INF/templates
message.basename=/WEB-INF/messages
input.encoding=UTF-8
output.encoding=UTF-8
reloadable=false
precompiled=false
localized=false
</pre>

<p>示例源码仓库：<a href="https://github.com/httl/httl-servlet">https://github.com/httl/httl-servlet</a></p>

<p>示例包下载参见：<a href="download.html">下载</a></p>

<div id="docUp" style="position: fixed; right: 80px; bottom: 80px; display: none;"><a href="#" onclick="document.body.scrollTop = 0; return false;"><img src="img/up.png" /><br/>回顶部</a></div>
</section>
</div>

<aside>
<div class="standard-right-nav">
  <p>文档目录</p>
  <div id="docIndex" class="nav-inner"></div>
</div>
</aside>   
 
</div>

    <footer>
      <nav class="footer-secondary-nav">
        <div class="companies">
          <p>版权所有 2011-<script type="text/javascript">document.write(new Date().getYear() + 1900);</script> HTTL开发团队.<br/><br/>本站可自适应: 手机, 平板, 电脑等.<br/></p>
        </div>
      </nav>
    </footer>
  </div>
</body>
</html>